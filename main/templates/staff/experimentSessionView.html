{%extends "base.html"%}
{% load crispy_forms_tags %}

{%block head%}
    <!-- Date-picker itself -->
<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"> -->
<link rel="stylesheet" href="https://unpkg.com/pc-bootstrap4-datetimepicker@4.17.50/build/css/bootstrap-datetimepicker.min.css"/>

<script src="https://unpkg.com/pc-bootstrap4-datetimepicker@4.17.50/build/js/bootstrap-datetimepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-bootstrap-datetimepicker@5"></script>

<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.min.css" integrity="sha256-DOS9W6NR+NFe1fUhEE0PGKY/fubbUCnOfTje2JMDw3Y=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.min.js" integrity="sha256-FEqEelWI3WouFOo2VWP/uJfs1y8KJ++FLh2Lbqc8SJk=" crossorigin="anonymous"></script> -->

    <script type="text/javascript">            

        $(document).ready(function(){             
            
            axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
            axios.defaults.xsrfCookieName = "csrftoken";

            // http://eonasdan.github.io/bootstrap-datetimepicker/
            Vue.component('date-picker', VueBootstrapDatetimePicker);

            $.extend(true, $.fn.datetimepicker.defaults, {
                icons: {
                    time: 'far fa-clock',
                    date: 'far fa-calendar',
                    up: 'fas fa-arrow-up',
                    down: 'fas fa-arrow-down',
                    previous: 'fas fa-chevron-left',
                    next: 'fas fa-chevron-right',
                    today: 'fas fa-calendar-check',
                    clear: 'far fa-trash-alt',
                    close: 'far fa-times-circle'
                }
                });

            var app = new Vue({
        
                delimiters: ['[[', ']]'],
                el: '#root',        
                data:{        
                    sessionURL:'',   
                    loading: true,   
                    message: null,       
                    showLoadingSpinner : true,
                    searchResults:[],
                    searchText:"",
                    searchAddResult:"",    
                    findButtonText:"Find",   
                    multiDayButtonText:"Multi Day <i class='fas fa-plus fa-xs'></i>",
                    inviteButtonText:"Invite <i class='fa fa-users'></i>",
                    showUnconfirmedButtonText:'Show <i class="fa fa-eye fa-xs"></i>',
                    cancelSessionButtonText:'Cancel Session <i class="fa fa-ban fa-xs"></i>',
                    searchResultsEmptyText:"",           //show when no results found from manual add
                    inviteResultsEmptyText:"",           //show when no subject fround for invitiation
                    sendMessageSubject:"",               //subject of send message     
                    sendMessageText:"",                  //text of send message     
                    emailMessageList:"",                 //emails for send message    
                    sendMessageButtonText:"Send Message <i class='fas fa-envelope fa-xs'></i>", 
                    session:{
                             invitationText:"",                         //invitation text with variables filled in 
                             invitationRawText:"",                      //invitation text with editable variables             
                             messageCount:"",                           //number of email messages sent out
                             invitationCount:"",                        //number of invition groups sent out
                             allowDelete:false,                         //allow session to be deleted or canceled
                             confirmedCount:0,                          //number of subjects that have confirmed to be in session
                             confirmedEmailList:[]},                    //list of emails that
                    recruitment_params:{                          //recruiment parameters
                            gender:[],
                            actual_participants:0,
                            registration_cutoff:0,
                            experience_min:0,
                            experience_max:1000,
                            experience_constraint:false,
                            institutions_exclude_all:0,
                            institutions_include_all:0,
                            experiments_exclude_all:0,
                            experiments_include_all:0,
                            allow_multiple_participations:false,
                            institutions_exclude:[],
                            institutions_include:[],
                            experiments_exclude:[],
                            experiments_include:[],
                            trait_constraints:[],
                        },
                    current_trait:{
                        id:0,
                        trait_id:0,
                        min_value:0,
                        max_vaue:0,
                    },
                    recruitmentTitle:"Recruitment Parameters",
                    subjectInvitations:[],                     //list of subject invitations
                    subjectInvitationCount:0,                  //binding to invition count input box
                    subjectInvitationList:"",                  //visable list of subject invitations
                    subjectCancelationList:"",                 //visable list of subject cancelations
                    currentSessionDayIndex:0,
                    manualAddSendInvitation:true,              //send an invitation when manually adding subjets
                    messageList:[],                            //list of email messages sent to users                      
                    showMessageListButtonText:'Show <i class="fa fa-eye fa-xs"></i>',  //button text for show message list 
                    invitationList:[],                         //list of invitations sent to users     
                    showInvitationListButtonText:'Show <i class="fa fa-eye fa-xs"></i>',  //button text for show invitation list                          
                    currentSessionDay:{ account:0,
                                        actual_participants:0,
                                        auto_reminder:true,
                                        enable_time:true,
                                        canceled:0,
                                        date_raw:"",
                                        date:"",
                                        date_local:"",
                                        reminder_time_raw:"",
                                        reminder_time:"",
                                        reminder_time_local:"",
                                        custom_reminder_time:false,
                                        account:0,
                                        id:0,
                                        length:0,
                                        location:0,
                                        registration_cutoff:0,
                                        experiment_session_days_user:[],
                                        experiment_session_days_user_unconfirmed:[],
                                        confirmedCount:"-",
                                        unConfirmedCount:"-"},                    
                    include_institutions_list:"",
                    exclude_institutions_list:"",
                    include_experiments_list:"",
                    exclude_experiments_list:"", 
                    include_schools_list:"",
                    exclude_schools_list:"",
                    subject_type_list:"",
                    trait_constraint_list:"", 
                    genders_list:"",        
                    buttonText1:"Update",  
                    buttonText2:"Update",
                    updateInvitationButtonText:'Update <i class="fas fa-sign-in-alt"></i>',
                    addTraitButtonText:'Add <i class="fas fa-plus fa-xs"></i>',
                    updateTraitButtonText:'Update <i class="fas fa-sign-in-alt"></i>',
                    subjectsCaption1:"Confirmed",
                    experiment_invitation_text:"",
                    options: {
                        // https://momentjs.com/docs/#/displaying/
                        format: 'MM/DD/YYYY hh:mm a ZZ',
                        useCurrent: true,
                        showClear: false,
                        showClose: true,
                        sideBySide: true,
                        },                         
                },
        
                methods:{     

                    //remove all the form errors
                    clearMainFormErrors:function(){

                        for(var item in app.$data.currentSessionDay)
                        {
                            $("#id_" + item).attr("class","form-control");
                            $("#id_errors_" + item).remove();
                        }

                        for(var item in app.$data.session)
                        {
                            $("#id_" + item).attr("class","form-control");
                            $("#id_errors_" + item).remove();
                        }
                    },

                    //update recruitment parameters 
                    updateRecruitmentParameters: function(){                       
                        axios.post('/experimentSession/{{id}}/', {
                                status :"updateRecruitmentParameters" ,                                
                                formData : $("#updateRecruitmentParametersForm").serializeArray(),                                                              
                            })
                            .then(function (response) {     
                                                            
                                status=response.data.status;                               

                                app.clearMainFormErrors();

                                if(status=="success")
                                {                                 
                                    app.$data.recruitment_params= response.data.recruitment_params;  
                                    app.updateDisplayLists();

                                    app.$data.cancelModal=false; 
                                    $('#recruitmentModalCenter').modal('toggle');
                                }
                                else
                                {                                
                                    app.displayErrors(response.data.errors);
                                }          

                                app.$data.buttonText1="Update"                      
                            })
                            .catch(function (error) {
                                console.log(error);
                                app.$data.searching=false;
                            });                        
                        },

                    //creates lists  of recruitment parameters
                    updateDisplayLists:function(errors){
                        var e = app.$data.recruitment_params;
                        
                        app.$data.include_institutions_list=app.updateDisplayLists2(e.institutions_include_full);
                        app.$data.exclude_institutions_list=app.updateDisplayLists2(e.institutions_exclude_full);
                        app.$data.include_experiments_list=app.updateDisplayLists2(e.experiments_include_full);
                        app.$data.exclude_experiments_list=app.updateDisplayLists2(e.experiments_exclude_full);
                        app.$data.include_schools_list=app.updateDisplayLists2(e.schools_include_full);
                        app.$data.exclude_schools_list=app.updateDisplayLists2(e.schools_exclude_full);
                        app.$data.trait_constraint_list=app.updateDisplayLists2(e.trait_constraints);
                        app.$data.genders_list=app.updateDisplayLists2(e.gender_full);
                        app.$data.subject_type_list=app.updateDisplayLists2(e.subject_type_full);
                        
                    },

                    updateDisplayLists2:function(list){
                        str="";

                        if(list.length == 0)
                        {
                            str = "---"
                        }   
                        else
                        {
                            for(var i=0;i<list.length;i++)
                            {
                                if(i>=1) str += " | ";
                                str += list[i].name;
                            }
                        }                         

                        return str;
                    },

                    //gets session info from the server
                    getSession: function(){
                        axios.post('/experimentSession/{{id}}/', {
                                status:"get",                                                              
                            })
                            .then(function (response) {                                                                   
                                app.$data.session= response.data.session;
                                app.$data.experiment_invitation_text = response.data.experiment_invitation_text;
                                app.$data.recruitment_params= response.data.recruitment_params;                                
                                app.updateDisplayLists();
                                app.$data.showLoadingSpinner=false;

                                if(app.$data.session.canceled)
                                {
                                    app.$data.cancelSessionButtonText = "*** CANCELED ***";
                                }
                            })
                            .catch(function (error) {
                                console.log(error);
                                //app.$data.searching=false;                                                              
                            });                        
                    },

                    //add a new session day
                    addSessionDay: function(){
                        if(app.$data.multiDayButtonText.includes("Multi"))
                        {
                            app.$data.multiDayButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                            axios.post('/experimentSession/{{id}}/', {
                                status:"addSessionDay",                                                              
                            })
                            .then(function (response) {                                   
                                app.$data.session.experiment_session_days= response.data.session.experiment_session_days;  
                                app.$data.session.confirmedCount = response.data.session.confirmedCount;             
                                
                                app.$data.multiDayButtonText = "Multi Day <i class='fas fa-plus fa-xs'></i>";
                            })
                            .catch(function (error) {
                                console.log(error);
                                //app.$data.searching=false;                                                              
                            });
                        }
                                                
                    },

                    //deletes a session day
                    removeSessionDay: function(id){
                        if(confirm("Delete Session Day?")){
                            axios.post('/experimentSession/{{id}}/', {
                                    status:"removeSessionDay",    
                                    id:id,                                                          
                                })
                                .then(function (response) {                                   
                                    app.$data.session.experiment_session_days= response.data.sessionDays.experiment_session_days;                                
                                    //app.updateDisplayLists();
                                })
                                .catch(function (error) {
                                    console.log(error);
                                    //app.$data.searching=false;                                                              
                                });                        
                        }
                    },

                    //invite subjects
                    inviteSubjects: function(){
                        if(!app.$data.inviteButtonText.includes("Invite")) return;

                        app.$data.inviteButtonText='<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>';

                        axios.post('/experimentSession/{{id}}/', {
                            status:"inviteSubjects",     
                            subjectInvitations:app.$data.subjectInvitations,                                                                
                        })
                        .then(function (response) {                                   

                            status = response.data.status
                            app.$data.session.experiment_session_days=response.data.es_min.experiment_session_days;
                            
                            app.$data.subjectInvitations = [];                    
                            app.$data.subjectInvitationCount = 0;               
                            app.$data.subjectInvitationList = ""; 

                            if(status != 'success')
                            {
                                userFails = response.data.userFails;

                                for (var i = 0; i < userFails.length; i++)
                                {
                                    app.$data.subjectInvitationList += 'Failed to add user to session: ';
                                    app.$data.subjectInvitationList += '<a href = "/userInfo/' + userFails[i].id + '" target="_blank" >'; 
                                    app.$data.subjectInvitationList += userFails[i].last_name + ", " + userFails[i].first_name + "</a><br>"
                                }
                                
                                if(response.data.mailResult.errorMessage != "")
                                {
                                    app.$data.subjectInvitationList += "<br>Email Send Error:<br>"
                                    app.$data.subjectInvitationList += response.data.mailResult.errorMessage + "<br><br>";
                                }                                
                            }                             
                            else
                            {      
                                                                            
                                //$('#inviteSubjectsModalCenter').modal('toggle');                             
                            }      
                            app.$data.subjectInvitationList +=  response.data.mailResult.mailCount + " invitations sent.";  
                            app.$data.inviteButtonText="";    
                            app.$data.session.invitationCount = response.data.invitationCount;               
                            
                        })
                        .catch(function (error) {
                            console.log(error);                                                                                        
                        }); 
                    },

                    //find subjects to invite
                    findSubjectsToInvite: function(){

                        if(app.$data.subjectInvitationList.includes('class')) return;

                        app.$data.subjectInvitationList='<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>';
                        app.$data.inviteResultsEmptyText="";

                        axios.post('/experimentSession/{{id}}/', {
                            status:"findSubjectsToInvite",    
                            number:app.$data.subjectInvitationCount,                                                          
                        })
                        .then(function (response) {                                   
                            app.$data.subjectInvitations = response.data.subjectInvitations;   
                            
                            var totalValid = response.data.totalValid;

                            var s ="";
                            var l = app.$data.subjectInvitations.length

                            for (var i = 0; i < l; i++) {
                                if (l > 1)
                                {
                                    if(i  > 0 && i != l-1)
                                        s += ", ";
                                    else if(i == l-1)
                                        s += " and "; 
                                }                                                                  

                                s += '<a href = "/userInfo/' + app.$data.subjectInvitations[i].id + '" target="_blank" >';
                                s += app.$data.subjectInvitations[i].first_name + " ";
                                s += app.$data.subjectInvitations[i].last_name; 
                                s += "</a>";
                            }

                            s += "<br><br>";
                            s += "<center><span style='color:gray;'>Total Found: " + totalValid + "<span><center>";

                            app.$data.subjectInvitationList = s;  
                            app.$data.inviteButtonText="Invite <i class='fa fa-users'></i>";    

                            if(s=="") app.$data.inviteResultsEmptyText="No Users Found<br><br>";                       
                            //app.updateDisplayLists();
                        })
                        .catch(function (error) {
                            console.log(error);                                                                                        
                        }); 
                    },

                    //clear subjects to invite
                    clearSubjectsToInvite: function(){
                        app.$data.subjectInvitationList ="";
                        app.$data.inviteButtonText="Invite <i class='fa fa-users'></i>";   
                        app.$data.inviteResultsEmptyText="";                      
                        },

                    //cancel a session day (not in use)
                    cancelSessionDay: function(){      
                        if( app.$data.session.canceled) return;
                        if(app.$data.subjectCancelationList=='<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>') return;
                        //if(app.$data.cancelSessionButtonText == "*** CANCELED ***" ) return;

                        app.$data.subjectCancelationList='<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>';

                        axios.post('/experimentSession/{{id}}/', {
                                status:"cancelSession",   
                                //id:id,                                                           
                            })
                            .then(function (response) {                                   
                                app.$data.session = response.data.session;

                                app.$data.cancelSessionButtonText='*** CANCELED ***';

                                app.$data.subjectCancelationList = "";

                                if(response.data.mailResult.errorMessage != "")
                                {
                                    app.$data.subjectCancelationList += "<br>Email Send Error:<br>"
                                    app.$data.subjectCancelationList += response.data.mailResult.errorMessage + "<br><br>";
                                }
                                else
                                {
                                    app.$data.subjectCancelationList +=  response.data.mailResult.mailCount + " cancelations sent.";                                     
                                }
                            })
                            .catch(function (error) {
                                console.log(error);
                                //app.$data.searching=false;                                                              
                            });                        
                    },

                    //update the session day parameters
                    updateSessionDay: function(){

                        var sessionCanceledChangedMessage=false;

                        if(app.$data.currentSessionDay.canceled != 
                           app.$data.session.experiment_session_days[app.$data.currentSessionDayIndex].canceled)
                        {
                            if(confirm("Send email about cancellation update?")){
                                var sessionCanceledChangedMessage=true;
                            }
                        }

                        var formData =  $("#mainForm2").serializeArray();

                        //tz = moment.tz(formData[1].value)

                        //formData[1].value = moment.tz(formData[1].value, tz ).utc().format();

                        axios.post('/experimentSession/{{id}}/', {
                                status:"updateSessionDay",   
                                id:app.$data.currentSessionDay.id, 
                                formData : formData,
                                sessionCanceledChangedMessage:sessionCanceledChangedMessage,                                                          
                            })
                            .then(function (response) {
                                status=response.data.status;

                                app.clearMainFormErrors();

                                if(status=="success")
                                {
                                    app.$data.session.experiment_session_days = response.data.sessionDays.experiment_session_days;                                
                                    app.$data.cancelModal=false;
                                    $('#setupModalCenter').modal('toggle');
                                }
                                else
                                {
                                    app.displayErrors(response.data.errors);
                                }                                  
                               
                            })
                            .catch(function (error) {
                                console.log(error);
                                //app.$data.searching=false;                                                              
                            });                        
                    },

                    //update the session day parameters
                    updateInvitationText: function(){

                       app.$data.updateInvitationButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                        axios.post('/experimentSession/{{id}}/', {
                                status:"updateInvitationText",   
                                invitationRawText : app.$data.session.invitationRawText,                                                          
                            })
                            .then(function (response) {
                                app.$data.session.invitationText = response.data.invitationText;
                                
                                app.$data.updateInvitationButtonText ='Update <i class="fas fa-sign-in-alt"></i>';
                                $('#editInvitationTextModal').modal('toggle');
                            
                            })
                            .catch(function (error) {
                                console.log(error);
                                //app.$data.searching=false;                                                              
                            });                        
                    },

                    //fill inviation text with experiment default
                    fillInvitationWithDefault:function(){
                        app.$data.session.invitationRawText = app.$data.experiment_invitation_text;
                    },

                    //displays to the form errors
                    displayErrors:function(errors){
                        for(var e in errors)
                        {
                            $("#id_" + e).attr("class","form-control is-invalid")
                            var str='<span id=id_errors_'+ e +' class="text-danger">';
                            
                            for(var i in errors[e])
                            {
                                str +=errors[e][i] + '<br>';
                            }

                            str+='</span>';
                            $("#div_id_" + e).append(str);  

                            var elmnt = document.getElementById("div_id_" + e);
                            elmnt.scrollIntoView();   
                        }
                    },

                    //if form is changed add * to button
                    recruitmentFormChange:function(){
                        app.$data.buttonText1="Update *";
                    },

                    //if form is changed add * to button
                    mainFormChange2:function(){
                        app.$data.buttonText2="Update *";
                    },

                    // fire when edit experiment model is shown, save copy for cancel
                    showEditRecruitment:function(){
                        app.$data.cancelModal=true;
                        app.$data.sessionBeforeEdit = Object.assign({}, app.$data.session);
                        app.$data.recruitment_paramsBeforeEdit = Object.assign({}, app.$data.recruitment_params);
                        $('#recruitmentModalCenter').modal('show');
                        app.clearMainFormErrors();
                    },

                    //fire when edit experiment model hides, cancel action if nessicary
                    hideEditRecruitment:function(){
                        if(app.$data.cancelModal)
                        {
                            Object.assign(app.$data.session, app.$data.sessionBeforeEdit);
                            Object.assign(app.$data.recruitment_params, app.$data.recruitment_paramsBeforeEdit);
                            app.$data.sessionBeforeEdit=null;
                            app.$data.buttonText1="Update";
                        }
                    },

                    //fire when the run session button is pressed
                    runSession:function(id)
                    {
                        window.open('/experimentSessionRun/' + id,"_self");
                    },

                     //add trait
                     addTrait:function(){
                        app.$data.addTraitButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                        axios.post('/experimentSession/{{id}}/', {
                                status : "addTrait" ,                                                                                                                                                             
                            })
                            .then(function (response) {                                   
                                
                                app.$data.recruitment_params = response.data.recruitment_params;  
                                app.updateDisplayLists();      
                                app.$data.addTraitButtonText = 'Add <i class="fas fa-plus fa-xs"></i>'; 
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                    },

                    //update trait
                    updateTrait:function(){
                        app.$data.updateTraitButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                        axios.post('/experimentSession/{{id}}/', {
                                status : "updateTrait",
                                trait_id:app.$data.current_trait.id,
                                formData : $("#traitConstraintForm").serializeArray(),                                                                                                                                                             
                            })
                            .then(function (response) {                                   
                                
                                status=response.data.status;                               

                                app.clearMainFormErrors();

                                if(status=="success")
                                {
                                    app.$data.recruitment_params = response.data.recruitment_params;  
                                    app.updateDisplayLists();   
                                    $('#updateTraitModal').modal('toggle');   
                                }
                                else
                                {
                                    app.$data.cancelModal=true;                           
                                    app.displayErrors(response.data.errors);
                                }

                                app.$data.updateTraitButtonText = 'Update <i class="fas fa-sign-in-alt"></i>'; 
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                    },

                    //delete trait
                    deleteTrait:function(id){
                        
                        axios.post('/experimentSession/{{id}}/', {
                                status : "deleteTrait", 
                                id:id,                                                                                                                                                            
                            })
                            .then(function (response) {                                   
                                
                                app.$data.recruitment_params = response.data.recruitment_params;  
                                app.updateDisplayLists();       
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                    },

                    //update require all trait constraints
                    updateRequireAllTraitContraints:function(){
                        axios.post('/experimentSession/{{id}}/', {
                                status : "updateRequireAllTraitContraints", 
                                value: app.$data.recruitment_params.trait_constraints_require_all,                                                                                                                                                            
                            })
                            .then(function (response) {                                   
                                
                                app.$data.recruitment_params = response.data.recruitment_params;         
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                    },

                    // fire when edit setup model is shown, save copy for cancel
                    showSetup:function(id){
                        app.$data.cancelModal=true;
                        app.$data.currentSessionDay= Object.assign({},app.$data.session.experiment_session_days[id]);
                        app.$data.currentSessionDayIndex=id;
                        app.$data.currentSessionDay.date_local = app.formatDate(app.$data.currentSessionDay.date_raw,false,true);
                        app.$data.currentSessionDay.reminder_time_local = app.formatDate(app.$data.currentSessionDay.reminder_time_raw,false,true);
                        app.$data.sessionBeforeEdit = Object.assign({}, app.$data.session);
                        app.$data.buttonText2="Update";
                        $('#setupModalCenter').modal('show');
                        //$('#id_date').datepicker('update');;
                        app.clearMainFormErrors();
                        //$('#id_date').val(app.formatDate(app.$data.currentSessionDay.date));
                    },

                    //fire when edit setup model hides, cancel action if nessicary
                    hideSetup:function(){
                        if(app.$data.cancelModal)
                        {
                            Object.assign(app.$data.session, app.$data.sessionBeforeEdit);
                            app.$data.sessionBeforeEdit=null;                            
                            app.$data.buttonText2="Update";
                        }
                    },

                    // fire when view subjects model is shown
                    showSubjects:function(id){
                        app.$data.cancelModal=true;
                        app.$data.currentSessionDay = Object.assign({},app.$data.session.experiment_session_days[id]);
                        app.$data.currentSessionDayIndex =id;
                        // app.$data.sessionBeforeEdit = Object.assign({}, app.$data.session);
                        app.$data.buttonText3="Update";
                        $('#subjectsModalCenter').modal('show');
                        // app.clearMainFormErrors();
                    },

                    //fire when view setup model closes, cancel action if nessicary
                    hideShowSubjects:function(){    
                        app.$data.showUnconfirmedButtonText = 'Show <i class="fa fa-eye fa-xs"></i>';                    
                    },

                    // fire when invite subjects subjects model is shown
                    showInviteSubjects:function(id){                        
                        $('#inviteSubjectsModalCenter').modal('show');
                        app.$data.inviteResultsEmptyText="";
                        // app.clearMainFormErrors();
                    },

                    //fire when hide invite subjects  model, cancel action if nessicary
                    hideInviteSubjects:function(){   

                        app.$data.subjectInvitations = [];                    
                        app.$data.subjectInvitationCount = 0;               
                        app.$data.subjectInvitationList = "";    
                        
                        app.$data.inviteButtonText="Invite <i class='fa fa-users'></i>";
                    },

                    // fire when cancel session model is shown
                    showCancelSession:function(id){ 

                        app.$data.subjectCancelationList = "";

                        l="";
                        s="Emails will be sent to the subjects that have confirmed: <br><br>"
                        c1=app.$data.session.experiment_session_days.length;
                        u1 = app.$data.session.confirmedEmailList

                        for(i=0;i<u1.length;i++)
                        {
                            //u2 = u1[i].user;

                            if (u1.length > 1)
                                {
                                    if(i  > 0 && i != u1.length-1)
                                        s += ", ";
                                    else if(i == u1.length-1)
                                        s += " and "; 
                                }                                                                  

                                s += '<a href = "/userInfo/' +u1[i].user_id + '" target="_blank" >';
                                s += u1[i].user_first_name + " ";
                                s += u1[i].user_last_name; 
                                s += "</a>";
                        }

                        app.$data.subjectCancelationList = s;
                        $('#cancelSessionModalCenter').modal('show');
                        // app.clearMainFormErrors();
                    },

                    //fire when hide cancel session  model, cancel action if nessicary
                    hideCancelSession:function(){   

                        
                    },

                     // fire when invite subjects subjects model is shown
                     showEditInvitation:function(id){    
                        $('#editInvitationTextModal').modal('show');
                        // app.clearMainFormErrors();
                    },

                     //fire when hide invite subjects  model, cancel action if nessicary
                    hideEditInvitation:function(){       
                                   
                    },

                    //invitation text changed, put * in buttonn text
                    invitationTextChange:function(){
                        app.$data.updateInvitationButtonText="Update <i class='fas fa-sign-in-alt'></i> *";
                    },

                    // fire when invite subjects subjects model is shown
                    showManuallyAddSubjects:function(id){    
                        app.$data.searchAddResult="";   
                        app.$data.searchResults=[];
                        app.$data.searchText=""; 
                        app.$data.searchAddResult = "";          
                        $('#manuallyAddSubjectsModalCenter').modal('show');
                        // app.clearMainFormErrors();
                    },

                    //fire when hide invite subjects  model, cancel action if nessicary
                    hideManuallyAddSubjects:function(){       
                        app.$data.searchResults=[];
                        app.$data.searchText="";  
                        app.$data.findButtonText="Find";             
                    },

                    // fire when invite subjects subjects model is shown
                    showSendMessage:function(id){    
    
                        app.$data.emailMessageList="";

                        for(i=0;i<app.$data.session.confirmedEmailList.length;i++)
                        {
                            v = app.$data.session.confirmedEmailList[i];

                            if(app.$data.emailMessageList != "")
                            {
                                app.$data.emailMessageList += ", ";
                            }
                           
                            app.$data.emailMessageList += '<a href = "/userInfo/' + v.user_id + '" target="_blank" >';
                            app.$data.emailMessageList += v.user_email; 
                            app.$data.emailMessageList += "</a>";
                        }

                        $('#sendMessageModalCenter').modal('show');
                        // app.clearMainFormErrors();
                    },

                    //fire when hide invite subjects  model, cancel action if nessicary
                    hideSendMessage:function(){       
                        app.$data.sendMessageText="";      
                        app.$data.emailMessageList="";    
                        app.$data.sendMessageSubject=""; 
                        app.$data.sendMessageButtonText = "Send Message <i class='fas fa-envelope fa-xs'></i>";       
                    },

                    //send an email to all of the confirmed subjects
                    sendEmailMessage:function(){

                        if(app.$data.sendMessageSubject == "" )
                        {
                            confirm("Add a subject to your message.");
                            return;
                        }

                        if(app.$data.sendMessageText == "" )
                        {
                            confirm("Your message is empty.");
                            return;
                        }

                        if(app.$data.sendMessageButtonText == '<i class="fas fa-spinner fa-spin"></i>') return;

                        app.$data.sendMessageButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                        axios.post('/experimentSession/{{id}}/', {
                                status:"sendMessage", 
                                subject:app.$data.sendMessageSubject,
                                text:app.$data.sendMessageText,                                                                                                                                              
                            })
                            .then(function (response) {
                                //status=response.data.status;

                                if(response.data.mailResult.errorMessage != "")
                                {
                                    app.$data.emailMessageList = "<br>Email Send Error:<br>"
                                    app.$data.emailMessageList += response.data.mailResult.errorMessage + "<br><br>";
                                }
                                else
                                {
                                    app.$data.emailMessageList =  response.data.mailResult.mailCount + " messages sent.";                                     
                                }   

                                app.$data.sendMessageButtonText = "Send Message <i class='fas fa-envelope fa-xs'></i>";                                                              
                                app.$data.session.messageCount = response.data.messageCount;
                            })
                            .catch(function (error) {
                                console.log(error);
                                //app.$data.searching=false;                                                              
                            });
                    },

                    //remove subject from a sesssion day
                    removeSubject: function(userId,esduId){

                        if(confirm("Remove subject from session?")){

                            $( '#removeSubject' + esduId ).replaceWith('<i class="fas fa-spinner fa-spin"></i>');

                            axios.post('/experimentSession/{{id}}/', {
                                status:"removeSubject",   
                                userId:userId, 
                                esduId:esduId,                                                                                                                        
                            })
                            .then(function (response) {
                                status=response.data.status;

                                app.$data.session.experiment_session_days=response.data.es_min.experiment_session_days;   
                                app.$data.currentSessionDay = Object.assign({},app.$data.session.experiment_session_days[ app.$data.currentSessionDayIndex]);

                                if(status=="success")
                                {
                                   
                                   // app.$data.session.experiment_session_days = response.data.sessionDays.experiment_session_days;                                                                    
                                }
                                else
                                {
                                    app.displayErrors(response.data.errors);
                                }                                   
                               
                            })
                            .catch(function (error) {
                                console.log(error);
                                //app.$data.searching=false;                                                              
                            });
                        }                       
                                                
                    },                  

                    //change a subject's confirmation status
                    confirmSubject: function(userId,esduId,confirmed){                       

                        $( '#confirmSubject' + esduId ).replaceWith('<i class="fas fa-spinner fa-spin"></i>');

                        axios.post('/experimentSession/{{id}}/', {
                            status:"changeConfirmation",   
                            userId:userId, 
                            esduId:esduId,  
                            confirmed:confirmed,                                                                                                                      
                        })
                        .then(function (response) {
                            status=response.data.status;

                            app.$data.session.experiment_session_days=response.data.es_min.experiment_session_days;   
                            app.$data.session.confirmedEmailList = response.data.es_min.confirmedEmailList;
                            app.$data.session.confirmedCount = response.data.es_min.confirmedCount;
                            app.$data.currentSessionDay = Object.assign({},app.$data.session.experiment_session_days[ app.$data.currentSessionDayIndex]);

                            if(status=="success")
                            {
                                
                                // app.$data.session.experiment_session_days = response.data.sessionDays.experiment_session_days;                                                                    
                            }
                            else
                            {
                                app.displayErrors(response.data.errors);
                            }            

                            app.updateDisplayLists();                       
                            
                        })
                        .catch(function (error) {
                            console.log(error);
                            //app.$data.searching=false;                                                              
                        });                      
                                                
                    },

                    //search for a subject to add manually
                    searchForSubject: function(){
                        if(app.$data.findButtonText != "Find") return;
                        if(app.$data.searchText == "") return;

                        app.$data.searchAddResult = "";

                        app.$data.findButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                        axios.post('/experimentSession/{{id}}/', {
                            status:"searchForSubject",   
                            searchInfo:app.$data.searchText,                                                                                                                         
                        })
                        .then(function (response) {

                               
                            app.$data.findButtonText = 'Find';  
                            status = response.data.status;

                            if (status == "success")
                            {
                                app.$data.searchResults=JSON.parse(response.data.users);

                                if(app.$data.searchResults.length > 0)
                                {
                                    app.$data.searchResultsEmptyText="";
                                }   
                                else
                                {
                                    app.$data.searchResultsEmptyText="No Users Found<br><br>";
                                } 
                            }
                            else
                            {
                                app.$data.searchResultsEmptyText=response.data.message + "<br><br>";
                            }

                                                                                
                        })
                        .catch(function (error) {
                            console.log(error);
                            //app.$data.searching=false;                                                              
                        });                                       
                                            
                    },

                    //clear search results
                    clearSearchForSubject: function(){

                        app.$data.searchResults=[];
                        app.$data.searchText="";  
                        app.$data.findButtonText="Find";                                    
                    },

                    //manually add subject to sessoin
                    manuallyAddSubject: function(u){

                        $( '#manualAdd' + u.id ).replaceWith('<i class="fas fa-spinner fa-spin"></i>');

                        axios.post('/experimentSession/{{id}}/', {
                            status:"manuallyAddSubject",   
                            user:u,
                            sendInvitation:app.$data.manualAddSendInvitation,                                                                                                                      
                        })
                        .then(function (response) {
                            app.$data.session.experiment_session_days=response.data.es_min.experiment_session_days;   
                            //$('#manuallyAddSubjectsModalCenter').modal('toggle');
                            app.$data.searchResults=[];
                            app.$data.searchText="";   
                            app.$data.searchAddResult = "";

                            status = response.data.status
                            
                            if(status != 'success')
                            {
                                user = response.data.user;
                                
                                app.$data.searchAddResult = 'Failed to add user to session: ';
                                app.$data.searchAddResult += '<a href = "/userInfo/' + user.id + '" target="_blank" >'; 
                                app.$data.searchAddResult += user.last_name + ", " + user.first_name + "</a><br>"
                                                                                             
                            }
                            else if(response.data.mailResult.errorMessage != "")
                            {
                                app.$data.searchAddResult += "<br>Email Send Error:<br>"
                                app.$data.searchAddResult += response.data.mailResult.errorMessage + "<br><br>";
                            }                            
                            else if(response.data.mailResult.mailCount == 0)
                            {
                                app.$data.searchAddResult = "Subject added, no invitation was sent.";
                            }
                            else
                            {                                               
                                app.$data.searchAddResult = "Subject added, an invitation was sent.";                                 
                            }      

                            app.$data.session.invitationCount = response.data.invitationCount;
                            
                        })
                        .catch(function (error) {
                            console.log(error);
                            //app.$data.searching=false;                                                              
                        });                                       
                                        
                    },

                    //show unconfirmed
                    showUnconfirmedSubjects: function(u){

                        app.$data.showUnconfirmedButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                        axios.post('/experimentSession/{{id}}/', {
                            status:"showUnconfirmedSubjects",   
                                                                                                                                                     
                        })
                        .then(function (response) {
                            app.$data.session.experiment_session_days=response.data.es_min.experiment_session_days;                             
                            app.$data.currentSessionDay = Object.assign({},app.$data.session.experiment_session_days[ app.$data.currentSessionDayIndex]);

                            app.$data.showUnconfirmedButtonText = 'Show <i class="fa fa-eye fa-xs"></i>';
                        })
                        .catch(function (error) {
                            console.log(error);
                            //app.$data.searching=false;                                                              
                        });                                       
                                        
                        },

                    //show message list
                    showMessages:function(){

                        app.$data.showMessageListButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                        axios.post('/experimentSession/{{id}}/', {
                            status:"showMessages",                                                                                                    
                        })
                        .then(function (response) {
                            app.$data.messageList = response.data.messageList;     

                            for(i=0;i<app.$data.messageList.length;i++)
                            {
                                m=app.$data.messageList[i];
                                m.date_raw=app.formatDate(m.date_raw,false,false);

                                emailMessageList="";

                                for(j=0;j<m.users.length;j++)
                                {                                            
                                        if (j >= 1)
                                        {
                                            if(j != m.users.length-1)
                                                emailMessageList += ", ";
                                            else
                                                emailMessageList += " and "; 
                                        }                                                                  

                                        emailMessageList += '<a href = "/userInfo/' + m.users[j].id + '" target="_blank" >';
                                        emailMessageList += m.users[j].first_name + " ";
                                        emailMessageList += m.users[j].last_name; 
                                        emailMessageList += "</a>";                                   
                                }

                                m.emailMessageList = emailMessageList;
                            }                        
                            
                            app.$data.showMessageListButtonText = 'Show <i class="fa fa-eye fa-xs"></i>';
                        })
                        .catch(function (error) {
                            console.log(error);
                            //app.$data.searching=false;                                                              
                        });
                    },

                    //show invitation list
                    showInvitations:function(){

                        app.$data.showInvitationListButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                        axios.post('/experimentSession/{{id}}/', {
                            status:"showInvitations",                                                                                                    
                        })
                        .then(function (response) {
                            app.$data.invitationList = response.data.invitationList;     

                            for(i=0;i<app.$data.invitationList.length;i++)
                            {
                                m=app.$data.invitationList[i];
                                m.date_raw=app.formatDate(m.date_raw,false,false);

                                emailMessageList="";

                                for(j=0;j<m.users.length;j++)
                                {                                            
                                        if (j >= 1)
                                        {
                                            if(j != m.users.length-1)
                                                emailMessageList += ", ";
                                            else
                                                emailMessageList += " and "; 
                                        }                                                                  

                                        emailMessageList += '<a href = "/userInfo/' + m.users[j].id + '" target="_blank" >';
                                        emailMessageList += m.users[j].first_name + " ";
                                        emailMessageList += m.users[j].last_name; 
                                        emailMessageList += "</a>";                                   
                                }

                                m.emailMessageList = emailMessageList;
                            }                        
                            
                            app.$data.showInvitationListButtonText = 'Show <i class="fa fa-eye fa-xs"></i>';
                        })
                        .catch(function (error) {
                            console.log(error);
                            //app.$data.searching=false;                                                              
                        });
                        },

                    //fire when edit trait model needs to be shown
                    showEditTraits:function(){                       
                        $('#editTraitsModal').modal('show');
                    },

                    //fire when hide edit traits
                    hideEditTraits:function(){
                    },

                    // fire when edit trait model is shown
                    showUpdateTrait:function(id,index){

                        tc = app.$data.recruitment_params.trait_constraints[index];

                        app.$data.cancelModal=true;
                        app.$data.current_trait.id = id;
                        app.$data.current_trait.min_value = tc.min_value;
                        app.$data.current_trait.max_value = tc.max_value;
                        app.$data.current_trait.trait_id = tc.trait_id;

                        $('#updateTraitModal').modal('show');
                        app.clearMainFormErrors();
                    },

                    //fire when edit experiment model hides, cancel action if nessicary
                    hideUpdateTrait:function(){
                        if(app.$data.cancelModal)
                        {
                        
                        }
                    },
                    
                    formatDate: function(value,date_only,show_timezone){
                        if (value) {        
                            //console.log(value);
                            if(date_only)
                            {
                                return moment(String(value)).local().format('MM/DD/YYYY');
                            }
                            else if(show_timezone)
                            {
                                return moment(String(value)).local().format('MM/DD/YYYY hh:mm a ZZ');
                            }
                            else
                            {
                                return moment(String(value)).local().format('MM/DD/YYYY hh:mm a');
                            }
                        }
                        else{
                            return "date format error";
                        }
                    },

                    checkToday: function(value1){
                        if(moment(value1).format("YYYY/MM/DD")== moment().format("YYYY/MM/DD"))
                        {
                            return true;
                        }
                        else
                        {
                            return false;
                        }
                        
                    },
                   
                    
                },

                //run when vue is mounted
                mounted: function(){
                    this.getSession();
                    //attach modal close events to vue
                    $('#recruitmentModalCenter').on("hidden.bs.modal", this.hideEditRecruitment);
                    $('#setupModalCenter').on("hidden.bs.modal", this.hideSetup);
                    $('#subjectsModalCenter').on("hidden.bs.modal", this.hideShowSubjects);
                    $('#id_date').on("dp.hide",this.mainFormChange2);
                    $('#inviteSubjectsModalCenter').on("hidden.bs.modal", this.hideInviteSubjects);
                    $('#cancelSessionModalCenter').on("hidden.bs.modal", this.hideCancelSession);
                    $('#manuallyAddSubjectsModalCenter').on("hidden.bs.modal", this.hideManuallyAddSubjects);
                    $('#sendMessageModalCenter').on("hidden.bs.modal", this.hideSendMessage);
                    $('#manuallyAddSubjectsModalCenter').on("hidden.bs.modal", this.hideEditInvitation);
                    $('#editTraitsModal').on("hidden.bs.modal", this.hideEditTraits);
                    $('#updateTraitModal').on("hidden.bs.modal", this.hideUpdateTrait);
                },                 
        
            });

            
        });

        
        
    </script>   

{%endblock head%}

{%block content%}    

<div class="row justify-content-xl-center">
    <div class="col col-md-10">
        <div class="card">
            <div class="card-header">
                Experiment Session: <a href="{% url 'experimentView' session.experiment.id %}">{{session.experiment}}</a>
            </div>
    
            <div class="card-body">

                {%include "snippits/recruitmentParametersTable.html"%}

                <div class = "row mt-2">
                    <div class="col col-md-4 text-right">
                        
                    </div>
                    <div class="col col-md-8">
                        <button class="btn btn-outline-primary btn-sm" type="button" v-on:click = "showInviteSubjects()" v-bind:disabled="session.allowEdit === false">Invite Subjects <i class="fa fa-users"></i></button>
                        <button class="btn btn-outline-primary btn-sm" type="button" v-on:click = "showSendMessage()">Send Message <i class="fas fa-envelope fa-xs"></i></button>
                        <button class="btn btn-outline-primary btn-sm" type="button" v-on:click = "showManuallyAddSubjects()" v-bind:disabled="session.allowEdit === false">Manually Add Subject <i class="fas fa-plus-square fa-xs"></i></button>
                        <button class="btn btn-outline-danger btn-sm" type="button" v-on:click = "showCancelSession()"  v-bind:disabled="session.allowEdit === false"><span v-html = "cancelSessionButtonText"></span></button> 
                    </div>               
                </div>

                <br>
                <br>                                    
                   
                <!-- session day table -->
                <div class="row">                   
                    <div class="col col-md-12">
                        <table class="table table-hover table-condensed">
                            <caption style="caption-side:top;text-align: center;">Session Day(s)</caption>
                            <thead>
                                <th width="35%">
                                    Date 
                                    <button class="btn btn-outline-success btn-sm" type="button" v-on:click = "addSessionDay()" v-bind:disabled="session.confirmedCount > 0"><span v-html="multiDayButtonText"></span></button> 
                                    <span v-if="showLoadingSpinner"><i class="fas fa-spinner fa-spin"></i></span>
                                </th> 
                                <th width="35%" style="text-align: center;">
                                    Confirmed/Invited
                                </th>                                                      
                                <th width="30%" style="text-align: center;">
                                    Control
                                </th>
                            </thead>
                            <tbody id="sessionList">                       
                                <tr v-for="(sd,index) in session.experiment_session_days" v-bind:key="sd.id">                                                                          
                                    <td>
                                        <span v-if="sd.enable_time">
                                            <span v-html="formatDate(sd.date_raw,false,false)"></span>
                                        </span>
                                        <span v-else>
                                            <span v-html="formatDate(sd.date_raw,true,false) + ' Anytime '"></span>
                                        </span>
                                        <span v-if="checkToday(sd.date_raw)" v-html="'(Today)'"></span> 

                                        <!-- room date time overlap -->
                                        <div v-for="(i,index) in sd.roomOverlap" v-bind:key="i.id">
                                            <a  v-bind:href='"/experimentSession/" + i.session_id' target="_blank">
                                               <span style="color: red;" v-html="'Overlaping Session: '+ i.name"></span><br>
                                            </a>
                                        </div>                                   
                                    </td>
                                    <td style="text-align: center;">                                        
                                        <div v-html="sd.confirmedCount+ '/' + (sd.confirmedCount + sd.unConfirmedCount)"></div>                                                                                
                                    </td>                               
                                    <td style="text-align: center;">                                       
                                        <div>
                                            <button style="width:80px;" class="btn btn-link btn-sm" type="button" v-on:click = "runSession(sd.id)"> Run <i class="fas fa-running fa-xs"></i></i></button>
                                        </div>
                                        <div>
                                            <button style="width:80px;" class="btn btn-outline-primary btn-sm" type="button" v-on:click = "showSetup(index)" v-bind:disabled="sd.complete === true"> Setup <i class="fas fa-info-circle fa-xs"></i></button> |
                                            <button style="width:90px;" class="btn btn-outline-primary btn-sm" type="button" v-on:click = "showSubjects(index)"> Subjects <i class="fas fa-users fa-xs"></i></button>
                                        </div>                               
                                        <div v-if="session.experiment_session_days.length > 1">                                         
                                            <div style="padding-top: 5px;">                                               
                                                <button style="width:80px;" class="btn btn-outline-danger btn-sm" type="button" v-on:click = "removeSessionDay(sd.id)" v-bind:disabled="sd.allowDelete === false"> Remove <i class="fas fa-times fa-xs"></i></button>
                                            </div>
                                        </div>                                                                                                                                                                                                                            
                                    </td>                            
                                </tr>                        
                            </tbody>
                        </table>
                    </div>
                </div>
                <br>
                <br>
                <br>
                <!-- invitations table -->
                <div class="row">
                    <div class="col col-md-12">
                        <table class="table table-hover table-condensed">
                            <caption style="caption-side:top;text-align: center;">Invitations (<span v-html="session.invitationCount"></span>)</caption>
                            <thead>
                                <th width="50%">
                                    Messsage 
                                    <button class="btn btn-outline-primary btn-sm" type="button" v-on:click = "showInvitations()"><span v-html="showInvitationListButtonText"></span></button>                                    
                                </th> 
                                <th width="40%" style="text-align: center;">
                                    Subjects
                                </th>                                                      
                                <th width="15%" style="text-align: center;">
                                    Info
                                </th>
                            </thead>
                            <tbody id="messgeList">                       
                                <tr v-for="(m,index) in invitationList" v-bind:key="m.id">                                                                          
                                    <td>                                        
                                        <div v-html="'Subject: ' + m.subjectText"></div> 
                                        <br>
                                        <div v-html="m.messageText"></div>  
                                        <br>
                                        <div v-html="'Parameters:'"></div>
                                        <div v-html="m.recruitment_params"></div>                                                                          
                                    </td>
                                    <td style="text-align: center;">                                        
                                        <div v-html="m.emailMessageList"></div>                                                                                
                                    </td>                               
                                    <td style="text-align: center;">                                       
                                        <div v-html="m.date_raw"></div>
                                        <br>
                                        <div v-html="'Email Count:<br>'+ m.mailResultSentCount"></div>
                                        <div v-if="m.mailResultErrorText != ''">
                                            <br>
                                            <div v-html="'Error: <br>' + m.mailResultErrorText"></div>
                                        </div>                                       
                                    </td>                            
                                </tr>                        
                            </tbody>
                        </table>
                    </div>
                </div>
                <br>
                <br>
                <br>
                <!-- messages table -->
                <div class="row">
                    <div class="col col-md-12">
                        <table class="table table-hover table-condensed">
                            <caption style="caption-side:top;text-align: center;">Messages (<span v-html="session.messageCount"></span>)</caption>
                            <thead>
                                <th width="50%">
                                    Messsage 
                                    <button class="btn btn-outline-primary btn-sm" type="button" v-on:click = "showMessages()"><span v-html="showMessageListButtonText"></span></button> 
                                    
                                </th> 
                                <th width="40%" style="text-align: center;">
                                    Subjects
                                </th>                                                      
                                <th width="15%" style="text-align: center;">
                                    Info
                                </th>
                            </thead>
                            <tbody id="messgeList">                       
                                <tr v-for="(m,index) in messageList" v-bind:key="m.id">                                                                          
                                    <td>                                        
                                        <div v-html="'Subject: ' + m.subjectText"></div> 
                                        <br>
                                        <div v-html="m.messageText"></div>                                                                           
                                    </td>
                                    <td style="text-align: center;">                                        
                                        <div v-html="m.emailMessageList"></div>                                                                                
                                    </td>                               
                                    <td style="text-align: center;">                                       
                                        <div v-html="m.date_raw"></div>
                                        <br>
                                        <div v-html="'Email Count:<br>'+ m.mailResultSentCount"></div>
                                        <div v-if="m.mailResultErrorText != ''">
                                            <br>
                                            <div v-html="'Error: <br>' + m.mailResultErrorText"></div>
                                        </div>                                       
                                    </td>                            
                                </tr>                        
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>      
        </div>
    </div>
</div>

<!-- send message to all confirmed subjects -->
<div class="modal" id="sendMessageModalCenter" tabindex="-1" role="dialog" aria-labelledby="manuallyAddSubjects" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Send Message</h5>                
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">   
                <div class="row">
                    <div class = "col">
                        <div class="form-group">
                            <label for="sendMessageSubject">Subject</label>
                            <input type="email" class="form-control" v-model="sendMessageSubject" id="sendMessageSubject" width="100%">
                          </div>
                    </div>
                </div>
                <div class="row">
                    <div class = "col">                      
                        <div class="form-group">
                            <label for="sendMessageText">Message</label>
                            <textarea class="form-control" v-model="sendMessageText" id="sendMessageText" rows="3" cols="100%"></textarea>
                          </div>
                    </div>
                </div>
                <hr>                
                <div class="row">
                    <div class="col">
                        <span v-html="emailMessageList"></span>
                    </div>
                </div>                

            </div>
            <div class="modal-footer">                            
                <button type="button" class="btn btn-outline-success" v-on:click = "sendEmailMessage()">
                    <span v-html="sendMessageButtonText"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- cancel session modal -->
<div class="modal" id="cancelSessionModalCenter" tabindex="-1" role="dialog" aria-labelledby="manuallyAddSubjects" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Cancel Session</h5>                
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">   
                   
                <div class="row">
                    <div class = "col">
                        <textarea  v-model="session.cancelationText" id="cancelationText1" rows="5" cols="100%" disabled></textarea>
                    </div>
                </div>
                <hr>                
                <div class="row">
                    <div class="col">
                        <span v-html="subjectCancelationList"></span>
                    </div>
                </div>                

            </div>
            <div class="modal-footer">   
                <div v-if="session.canceled == false">           
                    <button type="button" class="btn btn-outline-danger" v-on:click = "cancelSessionDay()">
                        Cancel Session <i class="fa fa-ban fa-xs"></i>
                    </button>
                </div>
                <div v-else>
                    <div style="color: red;">This session has been canceled.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- manually add subjects to sesssion modal-->
<div class="modal" id="manuallyAddSubjectsModalCenter" tabindex="-1" role="dialog" aria-labelledby="manuallyAddSubjects" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Manually Add Subject to Session</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">   
                <div class="row">
                    <div class = "col col-md-3">
                    </div>                  
                    <div class = "col col-md-6">
                        <div class="input-group mb-3">
                            <input id="manualSearchInput" v-on:keyup.enter="searchForSubject()" v-model="searchText" type="text" class="form-control" placeholder="Manually Add Subject" aria-label="Manual Add" aria-describedby="basic-addon2">
                            <div class="input-group-append">
                                <button class="btn btn-outline-primary" type="button" v-on:click = "searchForSubject()"><span v-html="findButtonText"></span></button>
                                <button class="btn btn-outline-primary" type="button" v-on:click ="clearSearchForSubject()">Clear</button>
                            </div>
                        </div>  
                        <div v-html="searchResultsEmptyText" style="text-align: center;color: red;"></div>                                            
                    </div>
                    <div class = "col col-md-3">
                        <div class="form-check">
                            <input v-model="manualAddSendInvitation" class="form-check-input" type="checkbox">
                            <label class="form-check-label" for="manualAddSendInvitation">
                                Send Invitation
                            </label>
                        </div>
                    </div>
                </div>  
                <div class="row mb-2">
                    <div class="col" style="text-align: center">
                        Recruitment violations cannot be manually added.
                    </div>
                </div>                               
                <div class="row">
                    <div class = "col">
                        <table class="table table-hover table-condensed">                            
                            <thead>
                                <th width="25%">
                                    Name 
                                </th>  
                                <th width="25%">
                                    ID 
                                </th> 
                                <th width="25%">
                                    Email 
                                </th>                                                                                
                                <th width="25%" style="text-align: center;">
                                    Control
                                </th>
                            </thead>
                            <tbody>
                                <tr v-for="(u,index) in searchResults" v-bind:key="u.id">                                
                                    <td>
                                        <a  v-bind:href='"/userInfo/" + u.id' target="_blank">
                                            <span v-html="u.last_name"></span>, <span v-html="u.first_name"></span>                                   
                                        </a>
                                    </td>
                                    <td>
                                        <span v-html="u.profile__studentID"></span>                                 
                                    </td>
                                    <td>
                                        <span v-html="u.email"></span>                                   
                                    </td>                               
                                    <td style="text-align: center;">
                                        <div v-if="session.canceled">
                                            <div style="text-align: center;color: red;">Session Canceled</div>
                                        </div>
                                        <div v-else-if="u.alreadyIn == 1">
                                            <div style="text-align: center;color: red;">Aready Added</div>
                                        </div>
                                        <div v-else>
                                            <button v-bind:id="'manualAdd' + u.id" type="button" class="btn btn-outline-success btn-sm" v-on:click = "manuallyAddSubject(u)" v-bind:disabled = "u.valid == 0">
                                                Add <i class="fas fa-plus-square fa-xs"></i>  
                                            </button>   
                                            <div v-if="u.valid == 0" style="text-align: center;color: red;">Rec. Violation</div>
                                            <div v-if="u.profile__blackballed == 1" style="text-align: center;color: red;">Blackballed</div>
                                        </div>                                                                             
                                    </td>                                
                                </tr>
                                
                            </tbody>                                                                      
                            
                        </table>
                        <div v-html = "searchAddResult">
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div class="modal-footer">                
                <button type="button" class="btn btn-outline-primary" v-on:click = "">
                    <i class="fas fa-sign-in-alt"></i> [[buttonText3]]
                </button>
            </div> -->
        </div>
    </div>
</div>

{%include "modals/invitationModal.html"%}
{%include "modals/editInvitationTextModal.html"%}
{%include "modals/recruitmentModal.html"%}
{%include "modals/editTraitsModal.html"%}
{%include "modals/updateTraitModal.html"%}
{%include "modals/sessionDayModal.html"%}

<!-- view subjects modal -->
<div class="modal" id="subjectsModalCenter" tabindex="-1" role="dialog" aria-labelledby="subjectsParameters" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Subjects</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">  
                <!-- confirmed   -->
                <div class="row">
                    <div class = "col">
                        <table class="table table-hover table-condensed">
                            <caption style="caption-side: top;" class="caption text-center">Confirmed ([[currentSessionDay.confirmedCount]])</caption>
                            <thead>
                                <th width="50%">
                                    Name 
                                </th>                                                                                   
                                <th width="50%" style="text-align: center;">
                                    Control
                                </th>
                            </thead>
                            <tbody>
                                <tr v-for="(esdu,index) in currentSessionDay.experiment_session_days_user" v-bind:key="esdu.id">                                
                                    <td>
                                        <span v-html="index+1"></span>) 
                                        <a  v-bind:href='"/userInfo/" + esdu.user.id' target="_blank">
                                            <span v-html="esdu.user.last_name"></span>, <span v-html="esdu.user.first_name"></span>
                                        </a>                                    
                                    </td>                                                                   
                                    <td style="text-align: center;">   
                                        {%if user.is_superuser%}                                     
                                            <button v-bind:id="'removeSubject' + esdu.id" type="button" class="btn btn-outline-danger btn-sm" v-on:click = "removeSubject(esdu.user.id,esdu.id)" v-bind:disabled="esdu.allowDelete === false">
                                                Remove <i class="fas fa-user-minus fa-xs"></i>  
                                            </button>
                                            
                                            <button v-bind:id="'confirmSubject' + esdu.id" type="button" class="btn btn-outline-primary btn-sm" v-on:click = "confirmSubject(esdu.user.id,esdu.id,'unconfirm')" v-bind:disabled="esdu.allowConfirm === false">
                                                Un-Confirm <i class="fas fa-arrow-down fa-xs"></i> 
                                            </button>                                        
                                        {%endif%}
                                    </td>                   
                                </tr>
                            </tbody>                                                                      
                            
                        </table>
                    </div>
                </div>
                <br>
                <!-- un confirmed -->
                <div class="row">
                    <div class = "col">
                        <table class="table table-hover table-condensed">
                            <caption style="caption-side: top;" class="caption text-center">Un-Confirmed ([[currentSessionDay.unConfirmedCount]])</caption>
                            <thead>
                                <th width="50%">
                                    Name   
                                    <button id="showUnconfirmed" type="button" class="btn btn-outline-primary btn-sm" v-on:click ="showUnconfirmedSubjects()">
                                        <span v-html="showUnconfirmedButtonText"></span>
                                    </button>                                 
                                </th>                                                                                   
                                <th width="50%" style="text-align: center;">
                                    Control
                                </th>
                            </thead>
                            <tbody>
                                <tr v-for="(esdu,index) in currentSessionDay.experiment_session_days_user_unconfirmed" v-bind:key="esdu.id">
                                    <td>                                        
                                        <span v-html="index+1"></span>)
                                        <a  v-bind:href='"/userInfo/" + esdu.user.id' target="_blank">
                                            <span v-html="esdu.user.last_name"></span>, <span v-html="esdu.user.first_name"></span>
                                        </a>                                                                           
                                    </td>                               
                                    <td style="text-align: center;">
                                        <button v-bind:id="'removeSubject' + esdu.id" type="button" class="btn btn-outline-danger btn-sm" v-on:click = "removeSubject(esdu.user.id,esdu.id)">
                                            Remove <i class="fas fa-user-minus fa-xs"></i>  
                                        </button>
                                        {%if user.is_superuser%}
                                        <button v-bind:id="'confirmSubject' + esdu.id" type="button" class="btn btn-outline-primary btn-sm" v-on:click = "confirmSubject(esdu.user.id,esdu.id,'confirm')"v-bind:disabled="esdu.valid == 0">
                                            Confirm <i class="fas fa-arrow-up fa-xs"></i> 
                                        </button>
                                        {%endif%}
                                        <div v-if="esdu.valid == 0" style="text-align: center;color: red;">Rec. Violation</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table> 
                    </div>
                </div>                   
                    
            </div>
            <!-- <div class="modal-footer">                
                <button type="button" class="btn btn-outline-primary" v-on:click = "">
                    <i class="fas fa-sign-in-alt"></i> [[buttonText3]]
                </button>
            </div> -->
        </div>
    </div>
</div>
{%endblock content%}
