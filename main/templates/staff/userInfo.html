{%extends "base.html"%}
{% load crispy_forms_tags %}
{% load humanize %}
{% load tz %}

{%block head%}
<title>User Info</title>

<script type="text/javascript">
    $(document).ready(function(){

        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
        axios.defaults.xsrfCookieName = "csrftoken";

        var app = new Vue({
        
            delimiters: ["[[", "]]"],
            el: '#root',        
            data:{
                session_day_attended:[{id:"0"}],
                session_day_upcoming:[{id:"0"}],
                invitations:[{id:"0"}],
                institutions:[],
                institutionsList:"",
                showInvitationsText:'Show <i class="fa fa-eye fa-xs"></i>',
                noInvitationsFoundText:'',
            },

            methods:{
                //get attended and upcoming sessions
                getSessions:function(){
                    axios.post('/userInfo/{{id}}/', {
                            status :"getSessions" ,                                                                                                                             
                        })
                        .then(function (response) {     
                            app.$data.session_day_attended = response.data.session_day_attended;
                            app.$data.session_day_upcoming = response.data.session_day_upcoming;  
                            app.$data.institutions = response.data.institutions;     

                            //format session data
                            for(var i=0;i<app.$data.session_day_attended.length;i++)
                            {
                                app.$data.session_day_attended[i].date = app.formatDate(app.$data.session_day_attended[i].date);
                                app.$data.session_day_attended[i].earnings = parseFloat(app.$data.session_day_attended[i].earnings).toFixed(2);
                                app.$data.session_day_attended[i].show_up_fee = parseFloat(app.$data.session_day_attended[i].show_up_fee).toFixed(2);
                            } 

                            for(var i=0;i<app.$data.session_day_upcoming.length;i++)
                            {
                                app.$data.session_day_upcoming[i].date = app.formatDate(app.$data.session_day_upcoming[i].date);
                                app.$data.session_day_upcoming[i].earnings = parseFloat(app.$data.session_day_upcoming[i].earnings).toFixed(2);
                                app.$data.session_day_upcoming[i].show_up_fee = parseFloat(app.$data.session_day_upcoming[i].show_up_fee).toFixed(2);
                            }

                            app.$data.institutionsList="";
                            //create institution list
                            for(var i=0;i<app.$data.institutions.length;i++)
                            {
                                if(i>0)
                                {
                                    app.$data.institutionsList += ", ";
                                }

                                app.$data.institutionsList += app.$data.institutions[i].name;
                            }                               
                        })
                        .catch(function (error) {
                            console.log(error);
                            app.$data.searching=false;
                        });                        
                    },

                // show the full invitation list
                showInvitations: function(value){
                    app.$data.showInvitationsText='<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>';

                    axios.post('/userInfo/{{id}}/', {
                            status :"getInvitations",                                                                                                                        
                        })
                        .then(function (response) {     
                            app.$data.invitations = response.data.invitations;
                            app.$data.noInvitationsFoundText = "No invitations found"

                            for(var i=0;i<app.$data.invitations.length;i++)
                            {
                                app.$data.invitations[i].date = app.formatDate(app.$data.invitations[i].date);
                                app.$data.invitations[i].earnings = parseFloat(app.$data.invitations[i].earnings).toFixed(2);
                                app.$data.invitations[i].show_up_fee = parseFloat(app.$data.invitations[i].show_up_fee).toFixed(2);
                            }

                            app.$data.showInvitationsText='Show <i class="fa fa-eye fa-xs"></i>';
                        })
                        .catch(function (error) {
                            console.log(error);                            
                        }); 
                },

                formatDate: function(value){
                        if (value) {        
                            //console.log(value);                    
                            return moment(String(value)).local().format('M/D/YYYY, h:mm a');
                        }
                        else{
                            return "date format error";
                        }
                    },    
            },

            mounted: function(){
                    this.getSessions();                    
            },
        });

        
    });
</script>
{%endblock head%}

{%block content%}
<div class="row justify-content-lg-center">
    <div class="col col-lg-10">
        <div class="card">                  
            <div class="card-header">
                Subject Information: {{u.last_name}}, {{u.first_name}}     
                {%if user.is_superuser%}
                <span class="float-right">
                    <a href="/admin/main/profile/{{u.profile.id}}/change">
                        Edit
                    </a>
                </span>
                {%endif%}                                                 
            </div>
            <div class="card-body">               
             
                <form id="userForm">                                            
                    <div class = "row">
                        <div class = "col"> 
                            <span class="float-right">Email:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{{u.email}}</span>
                        </div>
                        <div class = "col"> 
                            <span class="float-right">Email Confirmed:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{%if u.profile.emailConfirmed == "yes"%}Yes{%else%}<span style="color: red;"></span>No</span>{%endif%}</span>
                        </div>                
                    </div>
                    <div class = "row">
                        <div class = "col"> 
                            <span class="float-right">Major:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{{u.profile.major}}</span>
                        </div>
                        <div class = "col"> 
                            <span class="float-right">Gender:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{{u.profile.gender}}</span>
                        </div>               
                    </div>
                    <div class = "row">
                        <div class = "col"> 
                            <span class="float-right">Enrollment Status:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{{u.profile.subjectType}}</span>
                        </div>
                        <div class = "col"> 
                            <span class="float-right">Student Worker:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{%if u.profile.studentWorker%}Yes{%else%}No{%endif%}</span>
                        </div>               
                    </div>
                    <div class = "row">
                        <div class = "col"> 
                            <span class="float-right">Phone:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{{u.profile.phone}}</span>
                        </div>
                        <div class = "col"> 
                            <span class="float-right">Blackballed:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{%if u.profile.blackballed%}<span style="color: red;">Yes</span>{%else%}No{%endif%}</span>
                        </div>               
                    </div>
                    <div class = "row">
                        <div class = "col"> 
                            <span class="float-right">Chapman ID:</span>                            
                        </div>
                        <div class = "col"> 
                            <span class="float-left">{{u.profile.chapmanID}}</span>
                        </div>
                        <div class = "col"> 
                            <span class="float-right">In Institutions:</span>                             
                        </div>
                        <div class = "col"> 
                            <span v-html="institutionsList"></span> 
                        </div>               
                    </div>
                </form>
                <br>
                <br>
                <!-- upcoming table -->
                <table class="table table-hover table-condensed">
                    <caption style="caption-side:top;text-align: center;">Upcoming Experiments</caption>

                    <thead>
                        <th width="35%">
                            Experiment
                        </th> 
                        <th width="30%" style="text-align: center;">
                            Date
                        </th>                                                      
                        <th width="35%" style="text-align: center;">
                            Earnings<br>
                            Show Up | Experiment
                        </th>
                    </thead>
                    <tbody>                        
                        <tr v-for="(s,index) in session_day_upcoming" v-bind:key="s.id">
                            <td>                                
                                <a v-bind:href='"/experimentSession/" + s.session_id' v-html="s.title">[[s.title]]</a>
                            </td>
                            <td  style="text-align: center;">                                                                
                                [[s.date]]
                                <div v-if="s.multiDay">(Multi-day)</div>                                    
                            </td>
                            <td  style="text-align: center;">     
                                <div v-if="s.bumped">
                                    $[[s.show_up_fee]] | Bumped
                                </div>
                                <div v-else>
                                    $[[s.show_up_fee]] | $[[s.earnings]]
                                </div>                             
                            </td>
                        </tr>                        
                    </tbody>
                    <tfoot v-if="session_day_attended.length === 0">
                        <tr>
                            <td>The subject in not in any upcoming experiments</td>
                        </tr>
                    </tfoot>                                    
                </table>
                <br>
                <hr>
                <br>
                <!-- attended table -->
                <table class="table table-hover table-condensed">
                    <caption style="caption-side:top;text-align: center;">Experiments Attended</caption>

                    <thead>
                        <th width="35%">
                            Experiment
                        </th> 
                        <th width="30%" style="text-align: center;">
                            Date
                        </th>                                                      
                        <th width="35%" style="text-align: center;">
                            Earnings<br>
                            Show Up | Experiment
                        </th>
                    </thead>
                    <tbody>                        
                        <tr v-for="(s,index) in session_day_attended" v-bind:key="s.id">
                            <td>                                
                                <a v-bind:href='"/experimentSession/" + s.session_id' v-html="s.title">[[s.title]]</a>
                            </td>
                            <td  style="text-align: center;">                                                                
                                [[s.date]]
                                <div v-if="s.multiDay">(Multi-day)</div>                                    
                            </td>
                            <td  style="text-align: center;">     
                                <div v-if="s.bumped">
                                    $[[s.show_up_fee]] | Bumped
                                </div>
                                <div v-else>
                                    $[[s.show_up_fee]] | $[[s.earnings]]
                                </div>                             
                            </td>
                        </tr>                        
                    </tbody>
                    <tfoot v-if="session_day_attended.length === 0">
                        <tr>
                            <td>The subject has not attened any experiments</td>
                        </tr>
                    </tfoot>                                    
                </table>
                <br>     
                <hr>
                <br>           
                <!-- invitation table -->
                <table class="table table-hover table-condensed">
                    <caption style="caption-side:top;text-align: center;">Full Invitation List</caption>

                    <thead>
                        <th width="35%">
                            Experiment

                            <button id="showInvitations" type="button" class="btn btn-primary btn-sm" v-on:click ="showInvitations()">
                                <span v-html="showInvitationsText"></span>
                            </button> 
                        </th> 
                        <th width="30%" style="text-align: center;">
                            Date
                        </th>                                                      
                        <th width="35%" style="text-align: center;">
                            Status
                        </th>
                    </thead>
                    <tbody>                        
                        <tr v-for="(s,index) in invitations" v-bind:key="s.id">
                            <td>                                
                                <a v-bind:href='"/experimentSession/" + s.session_id' v-html="s.title">[[s.title]]</a>
                            </td>
                            <td  style="text-align: center;">                                                                
                                [[s.date]]
                                <div v-if="s.multiDay">(Multi-day)</div>                                    
                            </td>
                            <td  style="text-align: center;">  
                                <div v-if="s.noShow" style="color: red;">No Show</div>   
                                <div v-else-if="s.bumped">Bumped</div>
                                <div v-else-if="s.attended">Attended</div>
                                <div v-else-if="s.confirmed">Confirmed</div>                                                               
                            </td>
                        </tr>                        
                    </tbody>
                    <tfoot v-if="session_day_attended.length === 0">
                        <tr>
                            <td>[[noInvitationsFoundText]]</td>
                        </tr>
                    </tfoot>                                    
                </table>
            </div>                    
        </div>                
    </div>
</div>    
{%endblock content%}