{%extends "base.html"%}
{% load humanize %}

{%block head%}

    <script type="text/javascript">
        $(document).ready(function(){                         
            axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
            axios.defaults.xsrfCookieName = "csrftoken";

            var app = new Vue({
                delimiters: ['[[', ']]'],
                el: '#root',        
                data:{
                    baseURL:'{{request.get_full_path}}',                                                                                                                 
                    history:[],      
                    searchButtonText:'Search <i class="fas fa-search"></i>',
                },

                methods:{
                    //get list of users based on search
                    getHistory: function(){
                        if(app.$data.searchButtonText == '<i class="fas fa-spinner fa-spin"></i>') return;

                        app.$data.searchButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                        axios.post('{{request.get_full_path}}', {                            
                            action:"getUsers",
                            searchInfo:app.$data.searchInfo,
                            activeOnly:app.$data.activeOnly,                                
                        })
                        .then(function (response) {                         
                            app.functionTakeUserList(response);
                            app.$data.searchButtonText = 'Search <i class="fas fa-search"></i>';
                        })
                        .catch(function (error) {
                            console.log(error);                               
                        }); 
                    }, 
                  
                },
                
                mounted: function(){
                    $('#sendMessageModalCenter').on("hidden.bs.modal", this.hideSendMessage);
                },
            });
        });
    </script>
{%endblock head%}

{%block content%}
<div class="row justify-content-lg-center">
    <div class="col">
        <div class="card">                  
            <div class="card-header">
                PayPal API History                                                 
            </div>
            <div class="card-body">
                
                <!-- search results table -->
                <div class="row justify-content-center">
                    <div class="col">
                        <table class="table table-hover table-condensed table-responsive-xl">                            

                            <caption style="caption-side:top;text-align: center;">Users ([[searchCount]])</caption>
        
                            <thead>
                                <th scope="col">
                                    Email Address
                                </th> 
                                <th scope="col" style="text-align: center;">
                                    Amount
                                </th> 
                                <th scope="col" style="text-align: center;">
                                    Date
                                </th>
                                <th scope="col" style="text-align: center;">
                                    Memo
                                </th>                                                     
                                
                            </thead>
        
                            <tbody id="userList">                                                  
                                <tr v-for="(u,index) in history" v-bind:key="u.id">                                                                          
                                    <td> 
                                        <a :href="'/userInfo/' + u.id + '/' "><span v-html="u.last_name + ', ' + u.first_name"></span></a>                                        
                                    </td>
                                    <td style="text-align: center;">                                        
                                        <span v-html="u.email"></span>                                         
                                    </td>  
                                    <td style="text-align: center;">  
                                        <span v-html="u.profile__studentID"></span>
                                    </td>
                                    <td style="text-align: center;">  
                                        <span v-html="u.profile__type__name.toUpperCase()"></span>
                                    </td>                                                         
                                </tr>                                                    
                            </tbody>
                            
                        </table>  
                    </div>

                </div>         

            </div>                    
        </div>                
    </div>
</div>    

<!-- send message to all active subjects -->
<div class="modal" id="sendMessageModalCenter" tabindex="-1" role="dialog" aria-labelledby="manuallyAddSubjects" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Send message to all active subjects ({{activeCount|intcomma}})</h5>                
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">   
                <div class="row">
                    <div class = "col">
                        <div class="form-group">
                            <label for="sendMessageSubject">Subject</label>
                            <input type="email" class="form-control" v-model="sendMessageSubject" id="sendMessageSubject" width="100%">
                          </div>
                    </div>
                </div>
                <div class="row">
                    <div class = "col">                      
                        <div class="form-group">
                            <label for="sendMessageText">Message</label>
                            <textarea class="form-control" v-model="sendMessageText" id="sendMessageText" rows="3" cols="100%"></textarea>
                          </div>
                    </div>
                </div>
                <hr>                
                <div class="row">
                    <div class="col">
                        <span v-html="emailMessageList"></span>
                    </div>
                </div>                

            </div>
            <div class="modal-footer">
                (~1 minute per 100 emails, leave window open)                             
                <button type="button" class="btn btn-outline-success" v-on:click = "sendEmailMessage()">
                   <span v-html="sendMessageButtonText"></span>
                </button>
            </div>
        </div>
    </div>
</div>
{%endblock content%}