{%extends "base.html"%}
{% load crispy_forms_tags %}

{%block head%}

    <script type="text/javascript">
    $(document).ready(function(){
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
        axios.defaults.xsrfCookieName = "csrftoken";

        var app = new Vue({
        
            delimiters: ['[[', ']]'],
            el: '#root',        
            data:{
                upcomingInvitations:[],
                pastAcceptedInvitations:[],
                allInvitations:[],
                showInvitationsText:'Show <i class="fa fa-eye fa-xs"></i>',
                noInvitationsFoundText:'',
            },

            methods:{
                getCurrentInvitations:function(){
                    axios.post('/subjectHome/', {
                                    action :"getCurrentInvitations" ,                                                                                                                             
                                })
                                .then(function (response) {    
                                    
                                    app.takeUpcomingInvitations(response);
                                    
                                    app.$data.pastAcceptedInvitations=response.data.pastAcceptedInvitations;  
                                
                                    for(var i=0;i<app.$data.pastAcceptedInvitations.length;i++)
                                    {
                                        app.$data.pastAcceptedInvitations[i].date = app.formatDate(app.$data.pastAcceptedInvitations[i].date);
                                        app.$data.pastAcceptedInvitations[i].earnings = parseFloat(app.$data.pastAcceptedInvitations[i].earnings + 
                                                                                                   app.$data.pastAcceptedInvitations[i].show_up_fee).toFixed(2);
                                        app.$data.pastAcceptedInvitations[i].show_up_fee = parseFloat(app.$data.pastAcceptedInvitations[i].show_up_fee).toFixed(2);
                                    }
                                })
                                .catch(function (error) {
                                    console.log(error);                                    
                                });                        
                },
                
                acceptInvitation:function(id,index){
                    //$( '#acceptInvitation' + index ).replaceWith('<i class="fas fa-spinner fa-spin"></i>');

                    
                    app.$data.upcomingInvitations[index].waiting=true;

                    axios.post('/subjectHome/', {
                                    action :"acceptInvitation",
                                    id:id,                                                                                                                             
                                })
                                .then(function (response) {     
                                    app.takeUpcomingInvitations(response);                                                                     
                                })
                                .catch(function (error) {
                                    console.log(error);                                    
                                });                        
                },

                cancelAcceptInvitation:function(id,index){
                    //$( '#cancelAcceptInvitation' + index ).replaceWith('<i class="fas fa-spinner fa-spin"></i>');
                    app.$data.upcomingInvitations[index].waiting=true;

                    axios.post('/subjectHome/', {
                                    action :"cancelAcceptInvitation",
                                    id:id,                                                                                                                             
                                })
                                .then(function (response) {     
                                    app.takeUpcomingInvitations(response);                                                                     
                                })
                                .catch(function (error) {
                                    console.log(error);                                    
                                });                        
                },
                
                showAllInvitations:function(index){
                    app.$data.showInvitationsText='<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>';

                    axios.post('/subjectHome/', {
                                    action :"showAllInvitations",                                                                                                                            
                                })
                                .then(function (response) {     
                                    app.$data.allInvitations=response.data.allInvitations;      
                                    
                                    app.$data.noInvitationsFoundText = "No invitations found"

                                    for(var i=0;i<app.$data.allInvitations.length;i++)
                                    {
                                        app.$data.allInvitations[i].date = app.formatDate(app.$data.allInvitations[i].date);                                       
                                    }
                                    
                                    app.$data.showInvitationsText='Show <i class="fa fa-eye fa-xs"></i>';
                                })
                                .catch(function (error) {
                                    console.log(error);                                    
                                });                        
                },
                
                takeUpcomingInvitations:function(response){
                    app.$data.upcomingInvitations=response.data.upcomingInvitations;
                   

                    for(var i=0;i<app.$data.upcomingInvitations.length;i++)
                    {
                        app.$data.upcomingInvitations[i].waiting=false;
                        app.$data.upcomingInvitations[i].date = app.formatDate(app.$data.upcomingInvitations[i].date);
                    }
                },

                formatDate: function(value){
                        if (value) {        
                            //console.log(value);       
                            rValue =   moment(String(value)).local().format('dddd');
                            rValue +=   "<br>";
                            rValue +=   moment(String(value)).local().format('M/D/YYYY');   
                            rValue += "<br>";
                            rValue += moment(String(value)).local().format('h:mm a');       
                            return rValue;
                        }
                        else{
                            return "date format error";
                        }
                    },
            },

            mounted: function(){
                    this.getCurrentInvitations();                    
            },
        });

    });

    </script>
{%endblock head%}

{%block content%}
<div class="row justify-content-lg-center">
    <div class="col col-lg-6">
        <div class="card">                  
            <div class="card-header">
               Experiments
                
               <span class="float-right">
                    Need Help? Email:
               </span>
                                                           
            </div>
            <div class="card-body">               
                <!-- upcoming table -->
                <table class="table table-hover table-condensed">
                    <caption style="caption-side:top;text-align: center;">Upcoming Experiments</caption>

                    <thead>                         
                        <th width="50%" style="text-align: center;">
                            Date
                        </th>                                                      
                        <th width="50%" style="text-align: center;">
                            Control
                        </th>
                    </thead>
                    <tbody>                        
                        <tr v-for="(s,index) in upcomingInvitations" v-bind:key="s.id">
                           
                            <td  style="text-align: center;">                                                                
                                <span v-html=s.date></span>
                                <div v-if="s.multiDay">(Multi-day)</div>                                    
                            </td>
                            <td  style="text-align: center;">
                                <div v-if="s.waiting">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <div v-else>
                                    <div v-if="s.canceled">
                                        <span v-html="'*** Canceled ***'" style="color: red;"></span>
                                    </div>
                                    <div v-else-if="s.confirmed">
                                        <div style="margin-bottom: 5px">
                                            You are attending.
                                        </div>
                                        <button v-bind:id="'cancelAcceptInvitation' + s.id" type="button" class="btn btn-primary" v-on:click ="cancelAcceptInvitation(s.id,index)">
                                            <span v-html="'I no longer wish to attend.'"></span>
                                        </button>
                                    </div>
                                    <div v-else>
                                        <button v-bind:id="'acceptInvitation' + s.id" type="button" class="btn btn-success" v-on:click ="acceptInvitation(s.id,index)">
                                            <span v-html="'I want to attend.'"></span>
                                        </button> 
                                    </div>
                                </div>
                                                                                               
                            </td>
                        </tr>                        
                    </tbody>
                    <tfoot v-if="upcomingInvitations.length === 0">
                        <tr>
                            <td><span v-html="'No upcoming experiments.'"></span></td>
                        </tr>
                    </tfoot>                                    
                </table>
                <br>
                <hr>
                <br>
                <!-- attended table -->
                <table class="table table-hover table-condensed">
                    <caption style="caption-side:top;text-align: center;">Experiments Attended</caption>

                    <thead>                        
                        <th width="50%" style="text-align: center;">
                            Date
                        </th>                                                      
                        <th width="50%" style="text-align: center;">
                            Earnings
                        </th>
                    </thead>
                    <tbody>                        
                        <tr v-for="(s,index) in pastAcceptedInvitations" v-bind:key="s.id">                            
                            <td  style="text-align: center;">                                                                
                                <div v-html="s.date"></div>
                                <div v-if="s.multiDay"><span v-html="'(Multi-day)'"></span></div>                                    
                            </td>
                            <td  style="text-align: center;">     
                                <div v-if="s.bumped">
                                    <div v-html="'$'+s.show_up_fee"></div>
                                    <div v-html="'(Bumped)'"></div>
                                </div>
                                <div v-else>
                                    <span v-html="'$' + s.earnings"></span>
                                </div>                             
                            </td>
                        </tr>                        
                    </tbody>
                    <tfoot v-if="pastAcceptedInvitations.length === 0">
                        <tr>
                            <td>No experiments attended.</td>
                        </tr>
                    </tfoot>                                    
                </table> 
                <br>
                <hr>
                <br>              
                <!-- invitation table -->
                <table class="table table-hover table-condensed">
                    <caption style="caption-side:top;text-align: center;">Full Invitation List</caption>

                    <thead>
                        <th width="30%" style="text-align: center;">
                            Date
                            <button id="showInvitations" type="button" class="btn btn-primary btn-sm" v-on:click ="showAllInvitations()">
                                <span v-html="showInvitationsText"></span>
                            </button>
                        </th>                                                      
                        <th width="35%" style="text-align: center;">
                            Status
                        </th>
                    </thead>
                    <tbody>                        
                        <tr v-for="(s,index) in allInvitations" v-bind:key="s.id">                            
                            <td  style="text-align: center;">                                                                
                                <span v-html="s.date"></span>
                                <div v-if="s.multiDay"><span v-html="'(Multi-day)'"></span></div>                                    
                            </td>
                            <td  style="text-align: center;">  
                                <div v-if="s.noShow" style="color: red;"><span v-html="'No Show'"></span></div>   
                                <div v-else-if="s.bumped"><span v-html="'Bumped'"></span></div>
                                <div v-else-if="s.attended"><span v-html="'Attended'"></span></div>
                                <div v-else-if="s.confirmed"><span v-html="'Confirmed'"></span></div>                                                               
                            </td>
                        </tr>                        
                    </tbody>
                    <tfoot v-if="allInvitations.length === 0">
                        <tr>
                            <td><span v-html="noInvitationsFoundText"></span></td>
                        </tr>
                    </tfoot>                                    
                </table>
            </div>                    
        </div>                
    </div>
</div>    
{%endblock content%}